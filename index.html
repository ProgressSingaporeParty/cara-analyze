<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.min.js" integrity="sha512-ykZ1QQr0Jy/4ZkvKuqWn4iF3lqPZyij9iRv6sGqLRdTPkY69YX6+7wvVGmsdBbiIfN/8OdsI7HABjvEok6ZopQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js" integrity="sha512-vc58qvvBdrDR4etbxMdlTt4GBQk1qjvyORR2nrsPsFPyrs+/u5c3+1Ct6upOgdZoIl7eq6k3a1UPDSNAQi/32A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/sjcl/1.0.7/sjcl.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" integrity="sha512-jnSuA4Ss2PkkikSOLtYs8BlYIeeIK1h99ty4YfvRPAlzr377vr3CXDb7sb7eEEBYjDtcYj+AjBH3FLv5uSJuXg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">
        <title>CARA Analysis</title>
        <style>
            html, body {
                overflow-x: hidden;
                height: 100%;
                width: 100%;
                font-family: 'Roboto', sans-serif;
                font-size: large;
            }
        </style>
        <script>
            var baseDataEnc = {}
            var baseData = {}
            var detailData = {
                'tester': {
                    result: [],
                    log: [],
                    sync_timestamp: null
                },
                'sample' : {
                    result: [],
                    log: [],
                    sync_timestamp: null
                },
                'actual': {
                    result: [],
                    log: [],
                    sync_timestamp: null
                }
            }
            var navState = {
                phase: 'tester', 
                level: 'Constituency',
                name: null,
                numbers: 'count'
            }
            var getURL;
			var paginator = new (function(){
				var domArr = {}
				this.addDom=function(domName){
					domArr[domName] = {
						dom: document.getElementById(domName),
					};
				}
				this.setDom=function(setDomName){
                    console.log("setting dom " + setDomName)
					for(var domName in domArr){
						if(domName==setDomName){
							domArr[domName]["dom"].style.display="block";
						} else {
							domArr[domName]["dom"].style.display="none";
						}
					}
				}
			})()

            const getParties = function(row0){
                return Object.keys(row0).filter((e)=>{ return !['Constituency','Ward','Pd','TABLE'].includes(e) })
            }
            const pobj = (function(party){
                return (function(v) {
                    obj = {}
                    for (var p of party){
                        obj[p] = d3.sum(v, d => d[p])
                    }
                    obj['TOTAL']=d3.sum(v, d => d.PSP) + d3.sum(v, d => d.PAP)
                    obj['MARGIN']=Math.abs(d3.sum(v, d => d.PSP) - d3.sum(v, d => d.PAP))
                    obj['PSP_PCT']=~~Math.round(d3.sum(v, d => d.PSP) / (d3.sum(v, d => d.PSP) + d3.sum(v, d => d.PAP))*10000)/100
                    obj['PAP_PCT']=~~Math.round(d3.sum(v, d => d.PAP) / (d3.sum(v, d => d.PSP) + d3.sum(v, d => d.PAP))*10000)/100
                    return obj 
                })
            })
            var d3Table = new (function(){
                var dom;
                this.setDom=function(domName){
                    dom = document.getElementById(domName)
                }
                this.setContent=function(head, data, onclickFn){
                    $(dom).empty()
                    var table = d3.select(dom).append('table')
                        .style("border-collapse", "collapse")
                        .style("border", "2px black solid");
                    // header
                    table.append("thead").append("tr")
                        .selectAll("th").data(head)
                            .enter().append("th")
                            .text(function(d) { return d; })
                            .style("border", "1px black solid")
                            .style("padding", "5px")
                            .style("background-color", "lightgray")
                            .style("font-weight", "bold")
                            .style("text-transform", "uppercase");
                    // data
                    table.append("tbody")
                        .selectAll("tr").data(data)
                            .enter().append("tr")
                            .style('background-color', function(d){
                                if (d[7]>50) return '#FFCCCB';
                                else if(d[8]>50) return '#CCFEFF';
                                else return '';
                            })
                            .on("click", onclickFn)
                        .selectAll("td")
                            .data(function(d){ return d; })
                            .enter().append("td")
                            .style("border", "1px black solid")
                            .text(function(d){ return d; })
                    
                }
            })
            var d3Info = new (function(){
                var dom;
                this.setDom=function(domName){
                    dom = document.getElementById(domName)
                }
                this.setInfo=function(logs, ts){
                    if(logs.length > 0){
                        $(dom).text("Count: " + logs.length + ", Last Updated: " + logs[logs.length-1]['Timestamp']  + ", Last Synced: " + ts)
                    } else {
                        $(dom).text("Count: 0, Last Updated: -, Last Checked: " + ts)
                    }
                }
            })
            var d3Wrapper = new (function(){
                this.displayNational=function(result){
                    parties = getParties(result[0]); 
                    var head = ["GRC/SMC", ...parties, "TOTAL", "MARGIN", "PSP %", "PAP %"]
                    var data = d3.flatRollup(result, v => (pobj(parties)(v)), d => d.Constituency)
                        .map(([Constituency, values]) => ({Constituency, ...values})).map(Object.values);
                    var onclickFn = function(d, i){
                        displayor.showDetailLevel("Constituency", i[0])
                    }
                    d3Table.setContent(head, data, onclickFn)
                }
                this.displayConstituency=function(result, constituency){
                    parties = getParties(result[0]); 
                    var head = ["Ward", ...parties, "TOTAL", "MARGIN", "PSP %", "PAP %"];
                    result = result.filter(function(d,i) { return d.Constituency == constituency })
                    var data = d3.flatRollup(result, v => (pobj(parties)(v)), d => d.Ward)
                        .map(([Ward, values]) => ({Ward, ...values})).map(Object.values)
                    var onclickFn = function(d, i){
                        displayor.showDetailLevel("Ward", i[0])
                    }
                    d3Table.setContent(head, data, onclickFn)
                }
                this.displayWard=function(result, ward){
                    parties = getParties(result[0]); 
                    var head = ["Pd", ...parties, "TOTAL", "MARGIN", "PSP %", "PAP %"];
                    result = result.filter(function(d,i) { return d.Ward == ward })
                    var data = d3.flatRollup(result, v => (pobj(parties)(v)), d => d.Pd)
                        .map(([Pd, values]) => ({Pd, ...values})).map(Object.values);
                    var onclickFn = function(d, i){
                        displayor.showDetailLevel("Pd", i[0])
                    }
                    d3Table.setContent(head, data, onclickFn)
                }
                this.displayPd=function(log, pd){
                    var head = Object.keys(log[0]); 
                    log = log.filter(function(d,i) { return d.Pd == pd })
                    var data = log.map(Object.values);
                    var onclickFn = function(d, i){ }
                    d3Table.setContent(head, data, onclickFn)
                }
                this.displayNationalLog=function(logs, ts){
                    d3Info.setInfo(logs, ts)
                }
                this.displayConstituencyLog=function(results, logs, ts, constituency){
                    pds = results.filter(function(d,i){ return d.Constituency == constituency })
                        .map(function(v){ return v.Pd })
                    logs = logs.filter(function(d,i){ return pds.includes(d.Pd) })
                    d3Info.setInfo(logs, ts)
                }
                this.displayWardLog=function(results, logs, ts, ward){
                    pds = results.filter(function(d,i){ return d.Ward == ward })
                        .map(function(v){ return v.Pd })
                    logs = logs.filter(function(d,i){ return pds.includes(d.Pd) })
                    d3Info.setInfo(logs, ts)
                }
            })()
            var displayor = new (function(){
                var displayDOMs = {};
                var detailPhase = "actual";
                var detailLevel = "National";
                var detailParam = null;
                var levelStack = []
                this.addDom=function(name, htmlId){
                    displayDOMs[name] = document.getElementById(htmlId)
                
                }
                this.showPhase=function(phase){
                    detailPhase = phase;
                    this.showResult()
                }
                this.showDetailLevel=function(level, param){
                    levelStack.push({level:detailLevel, param:detailParam})
                    detailLevel = level;
                    detailParam = param;
                    this.showResult()
                }
                this.showResult=function(){
                    switch(detailLevel){
                        case 'National':
                            $(displayDOMs['header']).text(detailLevel + " ("+ detailPhase +")")
                            d3Wrapper.displayNationalLog(detailData[detailPhase]['log'], detailData[detailPhase]['sync_timestamp']); 
                            d3Wrapper.displayNational(detailData[detailPhase]['result']);
                            break;
                        case 'Constituency':
                            $(displayDOMs['header']).text("GRC/SMC" + ": " + detailParam + " ("+ detailPhase +")")
                            d3Wrapper.displayConstituencyLog(detailData[detailPhase]['result'], detailData[detailPhase]['log'], detailData[detailPhase]['sync_timestamp'], detailParam); 
                            d3Wrapper.displayConstituency(detailData[detailPhase]['result'], detailParam);
                            break;
                        case 'Ward':
                            $(displayDOMs['header']).text(detailLevel + ": " + detailParam + " ("+ detailPhase +")")
                            d3Wrapper.displayWardLog(detailData[detailPhase]['result'], detailData[detailPhase]['log'], detailData[detailPhase]['sync_timestamp'], detailParam); 
                            d3Wrapper.displayWard(detailData[detailPhase]['result'], detailParam);
                            break;
                        case 'Pd':
                            $(displayDOMs['header']).text(detailLevel + ": " + detailParam + " ("+ detailPhase +")")
                            d3Wrapper.displayPd(detailData[detailPhase]['log'], detailParam);
                            break;
                    }
                }
                this.back=function(){
                    var prev = levelStack.pop()
                    if (prev) {
                        detailLevel = prev.level;
                        detailParam = prev.param;
                        this.showResult()
                    }
                }
            })()

            function decrypt(pwd, dat){
                try {
                    dat = sjcl.decrypt(pwd, JSON.stringify(dat));
                    dat = JSON.parse(dat);
                    localStorage.setItem("pwd", pwd);
                    return dat
				} catch (err) {
					dat = {};
					localStorage.removeItem("pwd");
					console.warn(err)
                    return {}
				}
            }
            function unlock(pwd){
                baseData = decrypt(pwd, baseDataEnc)
                if (Object.keys(baseData).length != 0){
                    getURL = (x) => {
                        var f = new Function(baseData['f'].arguments, baseData['f'].body);
                        return f(baseData['c'], baseData[x])
                    }
                    paginator.setDom("page-display")
                    getData('actual')
                }
            }
            function logout(){
                localStorage.removeItem("pwd");
                paginator.setDom("page-login")
            }
            function getData(phase){
                d3.csv(getURL(phase+'_logs')).then((logRows)=> {
                    if (detailData[phase]['result'].length == 0 || detailData[phase]['log'].length != logRows.length){
                        d3.csv(getURL(phase)).then((resultRows)=> {
                            detailData[phase]['result'] = resultRows
                            detailData[phase]['log'] = logRows
                            detailData[phase]['sync_timestamp'] = new Date(Date.now()).toISOString()
                            displayor.showPhase(phase)
                        })
                    } else {
                        detailData[phase]['sync_timestamp'] = new Date(Date.now()).toISOString()
                        displayor.showPhase(phase)
                    }
                })
            }
            function back(){
                displayor.back()
            }
        </script>
    </head>
    <body>
        <div class="page container" id="page-login">
            <div class="row">
                <div class="form-outline mb-4">
                    <label class="form-label" for="password">Enter Password</label>
                    <input type="password" id="password" class="form-control" />
                </div>
            </div>
        </div>
        <div class="page" id="page-display" style="display:hidden">
            <div id="navigation-sticky">
                <nav class="navbar bg-light navbar-light navbar-expand-lg sticky-top" onclick="getData('actual',$('#display-data'),$('#display-logs'))">
                    Actual
                </nav>
                <nav class="navbar bg-light navbar-light navbar-expand-lg sticky-top" onclick="getData('sample',$('#display-data'),$('#display-logs'))">
                    Sample
                </nav>
                <nav class="navbar bg-light navbar-light navbar-expand-lg sticky-top" onclick="getData('tester',$('#display-data'),$('#display-logs'))">
                    Tester
                </nav>
                <nav class="navbar bg-light navbar-light navbar-expand-lg sticky-top" onclick=logout()>
                    Logout
                </nav>
            </div>
            <button onclick="back()"> &lt UP </button>
            <div id="display-head"></div>
            <div id="display-data"></div>
            <div id="display-logs"></div>

        </div>
		<script>
			paginator.addDom("page-login")
			paginator.addDom("page-display")
			paginator.setDom("page-login");
            displayor.addDom('header', "display-head")
            d3Table.setDom("display-data")
            d3Info.setDom("display-logs")
		</script>
        <script>
            var passDom = document.getElementById("password")
            passDom.addEventListener("keyup", function(e){
                if (e.key === "Enter"){
                    unlock(passDom.value)
                }
            })
            $.getJSON("dat.json", function(dat){
                baseDataEnc = dat
                var pwd = localStorage.getItem("pwd");
                if (pwd!=null){
                    unlock(pwd)
                }
            })
        </script>
    </body>
</html>